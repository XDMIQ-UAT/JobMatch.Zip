name: Deploy jobmatch.zip to Vercel (CI/CD)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  # Checks that must pass before deployment
  checks:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies (workspace)
        run: |
          npm ci --ignore-scripts 2>&1 | tee install.log || {
            echo "‚ö†Ô∏è npm ci failed, trying npm install..."
            npm install --ignore-scripts --legacy-peer-deps || true
          }
          # Skip Playwright installation if it fails
          if grep -q "playwright" install.log; then
            echo "‚ö†Ô∏è Playwright installation skipped (not required for deployment)"
          fi
          # Ensure frontend has its own node_modules for TypeScript resolution
          # Copy React and related packages from root to frontend to ensure TypeScript can find them
          cd frontend
          echo "Setting up frontend node_modules for TypeScript..."
          # Create node_modules directory if it doesn't exist
          mkdir -p node_modules
          # Copy React packages from root if they exist and aren't already in frontend
          if [ -d "../node_modules/react" ] && [ ! -d "node_modules/react" ]; then
            echo "Copying React from root to frontend..."
            cp -r ../node_modules/react node_modules/ 2>/dev/null || true
            cp -r ../node_modules/react-dom node_modules/ 2>/dev/null || true
            cp -r ../node_modules/react-router-dom node_modules/ 2>/dev/null || true
          fi
          # Copy React types
          if [ -d "../node_modules/@types/react" ] && [ ! -d "node_modules/@types/react" ]; then
            echo "Copying React types from root to frontend..."
            mkdir -p node_modules/@types
            cp -r ../node_modules/@types/react node_modules/@types/ 2>/dev/null || true
            cp -r ../node_modules/@types/react-dom node_modules/@types/ 2>/dev/null || true
          fi
          # If copying didn't work, try installing directly
          if [ ! -d "node_modules/react" ]; then
            echo "Installing React directly in frontend..."
            npm install --ignore-scripts --legacy-peer-deps --no-save --prefix . react react-dom react-router-dom @types/react @types/react-dom 2>&1 || true
          fi
          cd ..
          # Verify React and types are installed
          echo "Checking React installation..."
          ls -la node_modules/react 2>/dev/null && echo "‚úÖ React found in root" || echo "‚ö†Ô∏è React not in root"
          ls -la frontend/node_modules/react 2>/dev/null && echo "‚úÖ React found in frontend" || echo "‚ö†Ô∏è React not in frontend"
          ls -la node_modules/@types/react 2>/dev/null && echo "‚úÖ React types found in root" || echo "‚ö†Ô∏è React types not in root"
          ls -la frontend/node_modules/@types/react 2>/dev/null && echo "‚úÖ React types found in frontend" || echo "‚ö†Ô∏è React types not in frontend"

      - name: Lint frontend
        working-directory: ./frontend
        run: npm run lint

      - name: Lint backend
        working-directory: ./backend
        run: npm run lint

      - name: Type check frontend
        working-directory: ./frontend
        run: |
          # Verify React is accessible before typecheck
          echo "Verifying React installation for TypeScript..."
          ls -la node_modules/react/package.json 2>/dev/null && echo "‚úÖ React package.json found" || echo "‚ùå React package.json NOT found"
          ls -la node_modules/react/jsx-runtime.js 2>/dev/null && echo "‚úÖ React jsx-runtime found" || echo "‚ùå React jsx-runtime NOT found"
          ls -la node_modules/@types/react/index.d.ts 2>/dev/null && echo "‚úÖ React types found" || echo "‚ùå React types NOT found"
          # Run typecheck
          npm run typecheck

      - name: Generate Prisma Client
        working-directory: ./backend
        run: npm run generate

      - name: Type check backend
        working-directory: ./backend
        run: npm run typecheck

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build

      - name: Build backend
        working-directory: ./backend
        run: |
          npm run generate
          npm run build

      - name: Verify builds
        run: |
          if [ ! -d "frontend/dist" ]; then
            echo "‚ùå Frontend build failed"
            exit 1
          fi
          if [ ! -d "backend/dist" ]; then
            echo "‚ùå Backend build failed"
            exit 1
          fi
          echo "‚úÖ All builds successful"

  # Deploy to Vercel (unified frontend + backend)
  deploy:
    name: Deploy to Vercel
    runs-on: ubuntu-latest
    needs: checks
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies (workspace)
        run: |
          npm ci --ignore-scripts 2>&1 | tee install.log || {
            echo "‚ö†Ô∏è npm ci failed, trying npm install..."
            npm install --ignore-scripts --legacy-peer-deps || true
          }
          # Skip Playwright installation if it fails
          if grep -q "playwright" install.log; then
            echo "‚ö†Ô∏è Playwright installation skipped (not required for deployment)"
          fi

      - name: Generate Prisma Client
        working-directory: ./backend
        run: npm run generate

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build

      - name: Build backend
        working-directory: ./backend
        run: npm run build

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Deploy to Vercel Production
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: vercel --prod --yes

      - name: Deployment Summary
        run: |
          echo "‚úÖ Application deployed to Vercel (jobmatch.zip)"
          echo "üåê Production URL: https://jobmatch.zip"
          echo "üîó API available at: https://jobmatch.zip/api"

