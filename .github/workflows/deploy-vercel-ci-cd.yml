name: Deploy jobmatch.zip to Vercel (CI/CD)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  # Checks that must pass before deployment
  checks:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: Install dependencies (workspace)
        run: |
          npm ci --ignore-scripts 2>&1 | tee install.log || {
            echo "âš ï¸ npm ci failed, trying npm install..."
            npm install --ignore-scripts --legacy-peer-deps || true
          }
          # Skip Playwright installation if it fails
          if grep -q "playwright" install.log; then
            echo "âš ï¸ Playwright installation skipped (not required for deployment)"
          fi
          
          # Ensure frontend has React installed for TypeScript resolution
          echo "Setting up frontend node_modules for TypeScript..."
          cd frontend
          
          # Install React dependencies directly in frontend if not present
          if [ ! -d "node_modules/react" ] || [ ! -d "node_modules/react-dom" ] || [ ! -d "node_modules/react-router-dom" ]; then
            echo "Installing React dependencies in frontend..."
            npm install --ignore-scripts --legacy-peer-deps --no-save react@^18.2.0 react-dom@^18.2.0 react-router-dom@^7.9.6 @types/react@^18.2.46 @types/react-dom@^18.2.18 2>&1 || {
              echo "âš ï¸ Direct install failed, trying with workspace flag..."
              npm install --workspace=frontend --ignore-scripts --legacy-peer-deps react react-dom react-router-dom @types/react @types/react-dom 2>&1 || true
            }
          fi
          
          # Verify React installation
          echo "Verifying React installation..."
          if [ -d "node_modules/react" ]; then
            echo "âœ… React found in frontend/node_modules"
          else
            echo "âŒ React NOT found in frontend/node_modules"
            echo "Attempting to copy from root..."
            if [ -d "../node_modules/react" ]; then
              mkdir -p node_modules
              cp -r ../node_modules/react node_modules/ 2>/dev/null || true
              cp -r ../node_modules/react-dom node_modules/ 2>/dev/null || true
              cp -r ../node_modules/react-router-dom node_modules/ 2>/dev/null || true
            fi
          fi
          
          # Verify React types
          if [ -d "node_modules/@types/react" ]; then
            echo "âœ… React types found in frontend/node_modules/@types"
          else
            echo "âš ï¸ React types NOT found, copying from root..."
            if [ -d "../node_modules/@types/react" ]; then
              mkdir -p node_modules/@types
              cp -r ../node_modules/@types/react node_modules/@types/ 2>/dev/null || true
              cp -r ../node_modules/@types/react-dom node_modules/@types/ 2>/dev/null || true
            fi
          fi
          
          cd ..
          
          # Final verification
          echo "Final React installation check..."
          ls -la frontend/node_modules/react/package.json 2>/dev/null && echo "âœ… React package.json found" || echo "âŒ React package.json NOT found"
          ls -la frontend/node_modules/react/jsx-runtime.js 2>/dev/null && echo "âœ… React jsx-runtime found" || echo "âŒ React jsx-runtime NOT found"
          ls -la frontend/node_modules/@types/react/index.d.ts 2>/dev/null && echo "âœ… React types found" || echo "âŒ React types NOT found"

      - name: Lint frontend
        working-directory: ./frontend
        run: npm run lint

      - name: Lint backend
        working-directory: ./backend
        run: npm run lint

      - name: Type check frontend
        working-directory: ./frontend
        run: |
          # Verify React is accessible before typecheck
          echo "Verifying React installation for TypeScript..."
          ls -la node_modules/react/package.json 2>/dev/null && echo "âœ… React package.json found" || echo "âŒ React package.json NOT found"
          ls -la node_modules/react/jsx-runtime.js 2>/dev/null && echo "âœ… React jsx-runtime found" || echo "âŒ React jsx-runtime NOT found"
          ls -la node_modules/@types/react/index.d.ts 2>/dev/null && echo "âœ… React types found" || echo "âŒ React types NOT found"
          # Run typecheck
          npm run typecheck

      - name: Generate Prisma Client
        working-directory: ./backend
        run: npm run generate

      - name: Type check backend
        working-directory: ./backend
        run: npm run typecheck

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build

      - name: Build backend
        working-directory: ./backend
        run: |
          npm run generate
          npm run build

      - name: Verify builds
        run: |
          if [ ! -d "frontend/dist" ]; then
            echo "âŒ Frontend build failed"
            exit 1
          fi
          if [ ! -d "backend/dist" ]; then
            echo "âŒ Backend build failed"
            exit 1
          fi
          echo "âœ… All builds successful"

  # Deploy to Vercel (unified frontend + backend)
  # NOTE: CLI deployment disabled - use Vercel GitHub integration instead
  # GitHub integration automatically detects api/ folder as serverless functions
  # CLI deployment has issues detecting api/ folder
  # To enable: Connect repo to Vercel Dashboard â†’ Settings â†’ Git
  deploy:
    name: Deploy to Vercel (DISABLED - Use GitHub Integration)
    runs-on: ubuntu-latest
    needs: checks
    if: false  # Disabled - use Vercel GitHub integration instead
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: Install dependencies (workspace)
        run: |
          npm ci --ignore-scripts 2>&1 | tee install.log || {
            echo "âš ï¸ npm ci failed, trying npm install..."
            npm install --ignore-scripts --legacy-peer-deps || true
          }
          # Skip Playwright installation if it fails
          if grep -q "playwright" install.log; then
            echo "âš ï¸ Playwright installation skipped (not required for deployment)"
          fi

      - name: Generate Prisma Client
        working-directory: ./backend
        run: npm run generate

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build

      - name: Build backend
        working-directory: ./backend
        run: npm run build

      - name: Verify API function exists
        run: |
          echo "Checking for API function..."
          if [ ! -f "api/index.js" ]; then
            echo "âŒ ERROR: api/index.js not found!"
            echo "Current directory: $(pwd)"
            echo "Files in api/:"
            ls -la api/ 2>/dev/null || echo "api/ directory does not exist"
            exit 1
          fi
          echo "âœ… api/index.js found"
          echo "File size: $(stat -f%z api/index.js 2>/dev/null || stat -c%s api/index.js 2>/dev/null || echo 'unknown') bytes"
          echo "First few lines:"
          head -5 api/index.js

      - name: Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          # Set production flag based on branch
          prodRun=""
          if [[ ${GITHUB_REF} == "refs/heads/main" ]]; then
            prodRun="--prod"
            echo "ğŸš€ Deploying to production..."
          else
            echo "ğŸ” Deploying preview..."
          fi
          
          # Verify api/index.js exists before deployment
          if [ ! -f "api/index.js" ]; then
            echo "âŒ ERROR: api/index.js not found before deployment!"
            exit 1
          fi
          
          # Verify backend/dist exists (required by api/index.js)
          if [ ! -d "backend/dist" ]; then
            echo "âŒ ERROR: backend/dist not found! API function requires it."
            exit 1
          fi
          
          # Create .vercel directory and project.json for explicit project linking
          mkdir -p .vercel
          echo "{\"projectId\":\"${VERCEL_PROJECT_ID}\",\"orgId\":\"${VERCEL_ORG_ID}\"}" > .vercel/project.json
          
          # List files to verify api/ folder is present
          echo "Files in api/ directory:"
          ls -la api/ || echo "api/ directory not found!"
          
          # List root directory to see what Vercel will deploy
          echo "Root directory contents:"
          ls -la | head -20
          
          # Verify api/index.js is readable
          echo "Checking api/index.js:"
          cat api/index.js | head -10
          
          # Verify backend/dist exists
          echo "Checking backend/dist:"
          ls -la backend/dist/ | head -10
          
          # Deploy using npx vercel with explicit project settings
          echo "Deploying with Vercel CLI..."
          echo "Current directory: $(pwd)"
          echo "Files that will be deployed (api/ and frontend/dist):"
          find . -name "api" -type d
          find . -name "api" -type d -exec ls -la {} \;
          
          npx vercel --token ${VERCEL_TOKEN} --yes $prodRun 2>&1 | tee vercel-deploy.log
          
          # Check deployment output for function detection
          if grep -q "api/index.js" vercel-deploy.log; then
            echo "âœ… api/index.js detected in deployment"
          else
            echo "âš ï¸ api/index.js not mentioned in deployment log"
          fi

      - name: Deployment Summary
        run: |
          echo "âœ… Application deployed to Vercel"
          echo "ğŸŒ Production URL: https://jobmatch.zip"
          echo "ğŸ”— API available at: https://jobmatch.zip/api"

