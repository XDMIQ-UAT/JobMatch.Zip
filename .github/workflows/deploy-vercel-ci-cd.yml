name: Deploy jobmatch.zip to Vercel (CI/CD)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  # Checks that must pass before deployment
  checks:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: Install dependencies (workspace)
        run: |
          npm ci --ignore-scripts 2>&1 | tee install.log || {
            echo "‚ö†Ô∏è npm ci failed, trying npm install..."
            npm install --ignore-scripts --legacy-peer-deps || true
          }
          # Skip Playwright installation if it fails
          if grep -q "playwright" install.log; then
            echo "‚ö†Ô∏è Playwright installation skipped (not required for deployment)"
          fi
          
          # Ensure frontend has React installed for TypeScript resolution
          echo "Setting up frontend node_modules for TypeScript..."
          cd frontend
          
          # Install React dependencies directly in frontend if not present
          if [ ! -d "node_modules/react" ] || [ ! -d "node_modules/react-dom" ] || [ ! -d "node_modules/react-router-dom" ]; then
            echo "Installing React dependencies in frontend..."
            npm install --ignore-scripts --legacy-peer-deps --no-save react@^18.2.0 react-dom@^18.2.0 react-router-dom@^7.9.6 @types/react@^18.2.46 @types/react-dom@^18.2.18 2>&1 || {
              echo "‚ö†Ô∏è Direct install failed, trying with workspace flag..."
              npm install --workspace=frontend --ignore-scripts --legacy-peer-deps react react-dom react-router-dom @types/react @types/react-dom 2>&1 || true
            }
          fi
          
          # Verify React installation
          echo "Verifying React installation..."
          if [ -d "node_modules/react" ]; then
            echo "‚úÖ React found in frontend/node_modules"
          else
            echo "‚ùå React NOT found in frontend/node_modules"
            echo "Attempting to copy from root..."
            if [ -d "../node_modules/react" ]; then
              mkdir -p node_modules
              cp -r ../node_modules/react node_modules/ 2>/dev/null || true
              cp -r ../node_modules/react-dom node_modules/ 2>/dev/null || true
              cp -r ../node_modules/react-router-dom node_modules/ 2>/dev/null || true
            fi
          fi
          
          # Verify React types
          if [ -d "node_modules/@types/react" ]; then
            echo "‚úÖ React types found in frontend/node_modules/@types"
          else
            echo "‚ö†Ô∏è React types NOT found, copying from root..."
            if [ -d "../node_modules/@types/react" ]; then
              mkdir -p node_modules/@types
              cp -r ../node_modules/@types/react node_modules/@types/ 2>/dev/null || true
              cp -r ../node_modules/@types/react-dom node_modules/@types/ 2>/dev/null || true
            fi
          fi
          
          cd ..
          
          # Final verification
          echo "Final React installation check..."
          ls -la frontend/node_modules/react/package.json 2>/dev/null && echo "‚úÖ React package.json found" || echo "‚ùå React package.json NOT found"
          ls -la frontend/node_modules/react/jsx-runtime.js 2>/dev/null && echo "‚úÖ React jsx-runtime found" || echo "‚ùå React jsx-runtime NOT found"
          ls -la frontend/node_modules/@types/react/index.d.ts 2>/dev/null && echo "‚úÖ React types found" || echo "‚ùå React types NOT found"

      - name: Lint frontend
        working-directory: ./frontend
        run: npm run lint

      - name: Lint backend
        working-directory: ./backend
        run: npm run lint

      - name: Type check frontend
        working-directory: ./frontend
        run: |
          # Verify React is accessible before typecheck
          echo "Verifying React installation for TypeScript..."
          ls -la node_modules/react/package.json 2>/dev/null && echo "‚úÖ React package.json found" || echo "‚ùå React package.json NOT found"
          ls -la node_modules/react/jsx-runtime.js 2>/dev/null && echo "‚úÖ React jsx-runtime found" || echo "‚ùå React jsx-runtime NOT found"
          ls -la node_modules/@types/react/index.d.ts 2>/dev/null && echo "‚úÖ React types found" || echo "‚ùå React types NOT found"
          # Run typecheck
          npm run typecheck

      - name: Generate Prisma Client
        working-directory: ./backend
        run: npm run generate

      - name: Type check backend
        working-directory: ./backend
        run: npm run typecheck

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build

      - name: Build backend
        working-directory: ./backend
        run: |
          npm run generate
          npm run build

      - name: Verify builds
        run: |
          if [ ! -d "frontend/dist" ]; then
            echo "‚ùå Frontend build failed"
            exit 1
          fi
          if [ ! -d "backend/dist" ]; then
            echo "‚ùå Backend build failed"
            exit 1
          fi
          echo "‚úÖ All builds successful"

  # Deploy to Vercel (unified frontend + backend)
  # Only runs if Vercel token is available (optional deployment)
  deploy:
    name: Deploy to Vercel
    runs-on: ubuntu-latest
    needs: checks
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && secrets.VERCEL_TOKEN != ''
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: Install dependencies (workspace)
        run: |
          npm ci --ignore-scripts 2>&1 | tee install.log || {
            echo "‚ö†Ô∏è npm ci failed, trying npm install..."
            npm install --ignore-scripts --legacy-peer-deps || true
          }
          # Skip Playwright installation if it fails
          if grep -q "playwright" install.log; then
            echo "‚ö†Ô∏è Playwright installation skipped (not required for deployment)"
          fi

      - name: Generate Prisma Client
        working-directory: ./backend
        run: npm run generate

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build

      - name: Build backend
        working-directory: ./backend
        run: npm run build

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Verify Vercel Configuration
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          echo "Checking Vercel secrets..."
          echo ""
          
          # Check VERCEL_TOKEN
          if [ -z "$VERCEL_TOKEN" ]; then
            echo "‚ö†Ô∏è  VERCEL_TOKEN is not set - deployment will be skipped"
            echo "   ‚Üí To enable deployment, go to: Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "   ‚Üí Add secret named exactly: VERCEL_TOKEN"
            echo ""
            echo "‚úÖ Code quality checks passed - deployment skipped (no token)"
            exit 0  # Exit successfully, just skip deployment
          else
            TOKEN_LENGTH=${#VERCEL_TOKEN}
            echo "‚úÖ VERCEL_TOKEN is set (length: $TOKEN_LENGTH)"
          fi
          
          # Check VERCEL_ORG_ID
          if [ -z "$VERCEL_ORG_ID" ]; then
            echo "‚ö†Ô∏è  VERCEL_ORG_ID is not set - deployment will be skipped"
            echo "   ‚Üí To enable deployment, go to: Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "   ‚Üí Add secret named exactly: VERCEL_ORG_ID"
            echo ""
            echo "‚úÖ Code quality checks passed - deployment skipped (no org ID)"
            exit 0  # Exit successfully, just skip deployment
          else
            echo "‚úÖ VERCEL_ORG_ID is set: $VERCEL_ORG_ID"
          fi
          
          # Check VERCEL_PROJECT_ID
          if [ -z "$VERCEL_PROJECT_ID" ]; then
            echo "‚ö†Ô∏è  VERCEL_PROJECT_ID is not set - deployment will be skipped"
            echo ""
            echo "Troubleshooting steps:"
            echo "1. Go to: Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "2. Verify secret exists with exact name: VERCEL_PROJECT_ID"
            echo "3. Check for typos or extra spaces in the secret name"
            echo "4. Ensure secret value is not empty (should be a project ID string)"
            echo "5. Delete and recreate the secret if needed"
            echo ""
            echo "To find your Project ID:"
            echo "  - Vercel Dashboard ‚Üí Your Project ‚Üí Settings ‚Üí General ‚Üí Project ID"
            echo "  - Or run locally: vercel link && cat .vercel/project.json"
            echo ""
            echo "‚úÖ Code quality checks passed - deployment skipped (no project ID)"
            exit 0  # Exit successfully, just skip deployment
          else
            echo "‚úÖ VERCEL_PROJECT_ID is set: $VERCEL_PROJECT_ID"
          fi
          
          echo ""
          echo "All Vercel secrets are configured ‚úÖ"

      - name: Deploy to Vercel Production
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          echo "Verifying Vercel authentication..."
          TOKEN_LENGTH=${#VERCEL_TOKEN}
          echo "Token length: $TOKEN_LENGTH"
          
          # Check token length first (Vercel tokens are typically 24+ characters)
          if [ "$TOKEN_LENGTH" -lt 20 ]; then
            echo "‚ùå Token appears to be truncated (length: $TOKEN_LENGTH)"
            echo "Vercel tokens are typically 24+ characters"
            exit 1
          fi
          
          # Set project context (required for vercel CLI)
          if [ -n "$VERCEL_PROJECT_ID" ] && [ -n "$VERCEL_ORG_ID" ]; then
            echo "Setting Vercel project context..."
            # Create .vercel directory and project.json
            mkdir -p .vercel
            echo "{\"projectId\":\"$VERCEL_PROJECT_ID\",\"orgId\":\"$VERCEL_ORG_ID\"}" > .vercel/project.json
            echo "‚úÖ Project context set"
            cat .vercel/project.json
          fi
          
          # Test token validity with full debugging (including full token to detect truncation)
          echo "Testing Vercel authentication..."
          echo "Token length: $TOKEN_LENGTH"
          echo "Token first 10 chars: ${VERCEL_TOKEN:0:10}"
          echo "Token last 10 chars: ${VERCEL_TOKEN: -10}"
          echo "Full token value: $VERCEL_TOKEN"
          echo "ORG_ID: $VERCEL_ORG_ID"
          echo "PROJECT_ID: $VERCEL_PROJECT_ID"
          
          # Check if token matches expected length (24 chars for the token you provided)
          if [ "$TOKEN_LENGTH" -ne 24 ]; then
            echo "‚ö†Ô∏è  WARNING: Token length is $TOKEN_LENGTH, expected 24"
            echo "Token may have been truncated in GitHub Secrets!"
            echo "Expected token: gqP7wQnmO04NiPTJ3I35nqfj (24 chars)"
            echo "Actual token: $VERCEL_TOKEN"
          fi
          
          # Capture both stdout and stderr
          WHOAMI_OUTPUT=$(vercel whoami 2>&1)
          WHOAMI_EXIT=$?
          
          if [ $WHOAMI_EXIT -eq 0 ]; then
            echo "‚úÖ Vercel token is valid"
            echo "$WHOAMI_OUTPUT"
          else
            echo "‚ùå Vercel token authentication failed"
            echo ""
            echo "Full error output:"
            echo "$WHOAMI_OUTPUT"
            echo ""
            echo "Token verification:"
            echo "- Length: $TOKEN_LENGTH characters (expected: 24)"
            echo "- First 10: ${VERCEL_TOKEN:0:10}"
            echo "- Last 10: ${VERCEL_TOKEN: -10}"
            echo "- Full token: $VERCEL_TOKEN"
            echo "- Expected: gqP7wQnmO04NiPTJ3I35nqfj"
            echo ""
            echo "If token doesn't match expected value, check:"
            echo "1. GitHub Secrets ‚Üí VERCEL_TOKEN ‚Üí Verify full token copied"
            echo "2. No character limits in GitHub Secrets (should support 24+ chars)"
            echo "3. No spaces or quotes around token in GitHub Secrets"
            echo "4. Token scope: Full Account (not project-scoped)"
            exit 1
          fi
          
          echo ""
          echo "Deploying to Vercel production..."
          vercel --prod --yes

      - name: Deployment Summary
        run: |
          echo "‚úÖ Application deployed to Vercel (jobmatch.zip)"
          echo "üåê Production URL: https://jobmatch.zip"
          echo "üîó API available at: https://jobmatch.zip/api"

