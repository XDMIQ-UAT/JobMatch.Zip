name: Deploy jobmatch.zip to Vercel (CI/CD)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  # Checks that must pass before deployment
  checks:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies (workspace)
        run: |
          npm ci --ignore-scripts 2>&1 | tee install.log || {
            echo "‚ö†Ô∏è npm ci failed, trying npm install..."
            npm install --ignore-scripts --legacy-peer-deps || true
          }
          # Skip Playwright installation if it fails
          if grep -q "playwright" install.log; then
            echo "‚ö†Ô∏è Playwright installation skipped (not required for deployment)"
          fi
          # Ensure frontend has its own node_modules for TypeScript resolution
          # This is needed because TypeScript can't always resolve hoisted dependencies
          cd frontend
          if [ ! -d "node_modules/react" ]; then
            echo "Installing frontend dependencies locally for TypeScript..."
            npm install --ignore-scripts --legacy-peer-deps --no-save react react-dom react-router-dom @types/react @types/react-dom || true
          fi
          cd ..
          # Verify React and types are installed
          echo "Checking React installation..."
          ls -la node_modules/react 2>/dev/null && echo "‚úÖ React found in root" || echo "‚ö†Ô∏è React not in root"
          ls -la frontend/node_modules/react 2>/dev/null && echo "‚úÖ React found in frontend" || echo "‚ö†Ô∏è React not in frontend"
          ls -la node_modules/@types/react 2>/dev/null && echo "‚úÖ React types found in root" || echo "‚ö†Ô∏è React types not in root"
          ls -la frontend/node_modules/@types/react 2>/dev/null && echo "‚úÖ React types found in frontend" || echo "‚ö†Ô∏è React types not in frontend"

      - name: Lint frontend
        working-directory: ./frontend
        run: npm run lint

      - name: Lint backend
        working-directory: ./backend
        run: npm run lint

      - name: Type check frontend
        working-directory: ./frontend
        run: npm run typecheck

      - name: Type check backend
        working-directory: ./backend
        run: npm run typecheck

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build

      - name: Build backend
        working-directory: ./backend
        run: npm run build

      - name: Verify builds
        run: |
          if [ ! -d "frontend/dist" ]; then
            echo "‚ùå Frontend build failed"
            exit 1
          fi
          if [ ! -d "backend/dist" ]; then
            echo "‚ùå Backend build failed"
            exit 1
          fi
          echo "‚úÖ All builds successful"

  # Deploy Frontend to Vercel
  deploy-frontend:
    name: Deploy Frontend to Vercel
    runs-on: ubuntu-latest
    needs: checks
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies (workspace)
        run: |
          npm ci --ignore-scripts 2>&1 | tee install.log || {
            echo "‚ö†Ô∏è npm ci failed, trying npm install..."
            npm install --ignore-scripts --legacy-peer-deps || true
          }
          # Skip Playwright installation if it fails
          if grep -q "playwright" install.log; then
            echo "‚ö†Ô∏è Playwright installation skipped (not required for deployment)"
          fi

      - name: Build
        working-directory: ./frontend
        run: npm run build

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Deploy to Vercel Production
        working-directory: ./frontend
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: vercel --prod --yes

      - name: Deployment Summary
        run: |
          echo "‚úÖ Frontend deployed to Vercel (jobmatch.zip)"
          echo "üåê Production URL: https://jobmatch.zip"

  # Deploy Backend to Vercel
  deploy-backend:
    name: Deploy Backend to Vercel
    runs-on: ubuntu-latest
    needs: checks
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies (workspace)
        run: |
          npm ci --ignore-scripts 2>&1 | tee install.log || {
            echo "‚ö†Ô∏è npm ci failed, trying npm install..."
            npm install --ignore-scripts --legacy-peer-deps || true
          }
          # Skip Playwright installation if it fails
          if grep -q "playwright" install.log; then
            echo "‚ö†Ô∏è Playwright installation skipped (not required for deployment)"
          fi

      - name: Build
        working-directory: ./backend
        run: npm run build

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Deploy to Vercel Production
        working-directory: ./backend
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: vercel --prod --yes

      - name: Deployment Summary
        run: |
          echo "‚úÖ Backend deployed to Vercel"
          echo "üîó API available at configured Vercel URL"

